// Generated by CoffeeScript 1.8.0
var RealtimeAdapter, americano, application, initKonnectors, localization, params, patchKonnectors, poller;

americano = require('americano');

RealtimeAdapter = require('cozy-realtime-adapter');

localization = require('./server/lib/localization_manager');

initKonnectors = require('./server/init/konnectors');

patchKonnectors = require('./server/init/patch');

poller = require('./server/lib/konnector_poller');

process.env.TZ = 'UTC';

params = {
  name: 'konnectors',
  port: process.env.PORT || 9358,
  host: process.env.HOST || '127.0.0.1',
  root: __dirname
};

application = module.exports = function(callback) {
  return americano.start(params, function(app, server) {
    var realtime;
    realtime = RealtimeAdapter(server, ['konnector.update', 'folder.*']);
    return localization.initialize(function() {
      return initKonnectors(function() {
        return patchKonnectors(function() {
          poller.start();
          if (callback != null) {
            return callback(app, server);
          }
        });
      });
    });
  });
};

if (!module.parent) {
  application();
}
