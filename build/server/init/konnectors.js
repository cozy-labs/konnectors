// Generated by CoffeeScript 1.9.3
var Konnector, async, createKonnectors, fs, getKonnectorsToCreate, initializeKonnector, konnectorModules, konnectorResetValue, log, path;

path = require('path');

fs = require('fs');

async = require('async');

log = require('printit')({
  prefix: null,
  date: true
});

Konnector = require('../models/konnector');

konnectorModules = require('../lib/konnector_hash');

module.exports = function(done) {
  return Konnector.all(function(err, konnectors) {
    var konnectorHash;
    if (err) {
      log.error(err);
      return callback(err);
    } else {
      konnectorHash = {};
      return async.eachSeries(konnectors, function(konnector, callback) {
        konnectorHash[konnector.slug] = konnector;
        return konnectorResetValue(konnector, callback);
      }, function(err) {
        var konnectorsToCreate;
        if (err) {
          log.error(err);
        }
        konnectorsToCreate = getKonnectorsToCreate(konnectorHash);
        if (konnectorsToCreate.length === 0) {
          return done();
        }
        return createKonnectors(konnectorsToCreate, done);
      });
    }
  });
};

konnectorResetValue = function(konnector, callback) {
  if (konnector.isImporting === true) {
    konnector.isImporting = false;
    return konnector.save(function(err) {
      if (err) {
        log.debug(konnector.slug + " | " + err);
      } else {
        log.debug(konnector.slug + ": reseting isImporting");
      }
      return callback();
    });
  } else {
    return callback();
  }
};

getKonnectorsToCreate = function(konnectorHash) {
  var konnectorModule, konnectorsToCreate, name;
  konnectorsToCreate = [];
  for (name in konnectorModules) {
    konnectorModule = konnectorModules[name];
    if (konnectorHash[konnectorModule.slug] == null) {
      konnectorsToCreate.push(konnectorModule);
    }
  }
  return konnectorsToCreate;
};

createKonnectors = function(konnectorsToCreate, done) {
  return async.eachSeries(konnectorsToCreate, function(konnector, callback) {
    return initializeKonnector(konnector, callback);
  }, function(err) {
    log.info('All konnectors created');
    return done();
  });
};

initializeKonnector = function(konnector, callback) {
  return konnector.init(function(err) {
    if (err) {
      log.error(err);
      return callback(err);
    } else {
      log.debug("creating " + konnector.slug);
      return Konnector.create(konnector, function(err) {
        if (err) {
          log.error(err);
        }
        return callback(err);
      });
    }
  });
};
