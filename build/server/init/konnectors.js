// Generated by CoffeeScript 1.10.0
var Konnector, async, createKonnectors, fs, getKonnectorsToCreate, initializeKonnector, konnectorModules, konnectorResetValue, log, path;

path = require('path');

fs = require('fs');

async = require('async');

log = require('printit')({
  prefix: null,
  date: true
});

Konnector = require('../models/konnector');

konnectorModules = require('../lib/konnector_hash');

module.exports = function(callback) {
  return Konnector.all(function(err, konnectors) {
    var konnectorHash;
    if (err) {
      log.error(err);
      return callback(err);
    } else {
      konnectorHash = {};
      return async.eachSeries(konnectors, function(konnector, done) {
        konnectorHash[konnector.slug] = konnector;
        return konnectorResetValue(konnector, done);
      }, function(err) {
        var konnectorsToCreate;
        if (err) {
          log.error(err);
        }
        konnectorsToCreate = getKonnectorsToCreate(konnectorHash);
        if (konnectorsToCreate.length === 0) {
          return callback();
        } else {
          return createKonnectors(konnectorsToCreate, callback);
        }
      });
    }
  });
};

konnectorResetValue = function(konnector, callback) {
  if (konnector.isImporting === true) {
    return konnector.updateAttributes({
      isImporting: false
    }, function(err) {
      if (err) {
        log.debug(konnector.slug + " | " + err);
      } else {
        log.debug(konnector.slug + ": reseting isImporting");
      }
      return callback();
    });
  } else {
    return callback();
  }
};

getKonnectorsToCreate = function(konnectorHash) {
  var konnectorModule, konnectorsToCreate, name;
  konnectorsToCreate = [];
  for (name in konnectorModules) {
    konnectorModule = konnectorModules[name];
    if (konnectorHash[konnectorModule.slug] == null) {
      konnectorsToCreate.push(konnectorModule);
      log.info("New konnector to init: " + name);
    }
  }
  return konnectorsToCreate;
};

createKonnectors = function(konnectorsToCreate, callback) {
  return async.eachSeries(konnectorsToCreate, function(konnector, done) {
    return initializeKonnector(konnector, done);
  }, function(err) {
    log.info('All konnectors created');
    return callback();
  });
};

initializeKonnector = function(konnector, callback) {
  log.debug("creating " + konnector.slug);
  if (konnector.init != null) {
    return konnector.init(function(err) {
      if (err) {
        log.error(err);
        return callback(err);
      } else {
        return Konnector.create(konnector, function(err) {
          if (err) {
            log.error(err);
          }
          return callback(err);
        });
      }
    });
  } else {
    return Konnector.create(konnector, function(err) {
      if (err) {
        log.error(err);
      }
      return callback(err);
    });
  }
};
