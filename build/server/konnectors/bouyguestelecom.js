// Generated by CoffeeScript 1.11.1
var PhoneBill, async, cheerio, cozydb, fetcher, filterExisting, fs, linkBankOperation, localization, log, logIn, moment, parsePage, qs, request, saveDataAndFile;

cozydb = require('cozydb');

fs = require('fs');

qs = require('querystring');

request = require('request');

moment = require('moment');

cheerio = require('cheerio');

async = require('async');

fetcher = require('../lib/fetcher');

filterExisting = require('../lib/filter_existing');

saveDataAndFile = require('../lib/save_data_and_file');

localization = require('../lib/localization_manager');

linkBankOperation = require('../lib/link_bank_operation');

log = require('printit')({
  prefix: "Bouygues Telecom",
  date: true
});

PhoneBill = cozydb.getModel('PhoneBill', {
  date: Date,
  vendor: String,
  amount: Number,
  fileId: String,
  binaryId: String,
  pdfurl: String
});

PhoneBill.all = function(callback) {
  return PhoneBill.request('byDate', callback);
};

module.exports = {
  name: "Bouygues Telecom",
  slug: "bouyguestelecom",
  description: 'konnector description bouygues',
  vendorLink: "https://www.bouyguestelecom.fr/",
  category: 'telecom',
  color: {
    hex: '#009DCC',
    css: '#009DCC'
  },
  fields: {
    phoneNumber: {
      type: "text"
    },
    password: {
      type: "password"
    },
    folderPath: {
      type: "folder",
      advanced: true
    }
  },
  dataType: ['bill'],
  models: {
    phonebill: PhoneBill
  },
  init: function(callback) {
    var map;
    map = function(doc) {
      return emit(doc.date, doc);
    };
    return PhoneBill.defineRequest('byDate', map, function(err) {
      return callback(err);
    });
  },
  fetch: function(requiredFields, callback) {
    log.info("Import started");
    return fetcher["new"]().use(logIn).use(parsePage).use(filterExisting(log, PhoneBill)).use(saveDataAndFile(log, PhoneBill, 'bouygues', ['facture'])).use(linkBankOperation({
      log: log,
      model: PhoneBill,
      identifier: 'bouyg',
      minDateDelta: 4,
      maxDateDelta: 20,
      amountDelta: 0.1
    })).args(requiredFields, {}, {}).fetch(function(err, fields, entries) {
      var localizationKey, notifContent, options, ref;
      if (err) {
        return callback(err);
      }
      log.info("Import finished");
      notifContent = null;
      if ((entries != null ? (ref = entries.filtered) != null ? ref.length : void 0 : void 0) > 0) {
        localizationKey = 'notification bouygues';
        options = {
          smart_count: entries.filtered.length
        };
        notifContent = localization.t(localizationKey, options);
      }
      return callback(null, notifContent);
    });
  }
};

logIn = function(requiredFields, bills, data, next) {
  var billUrl, loginOptions, loginUrl, userAgent;
  loginUrl = 'https://www.mon-compte.bouyguestelecom.fr/cas/login';
  billUrl = "https://www.bouyguestelecom.fr/parcours/mes-factures/historique";
  userAgent = 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:36.0) ' + 'Gecko/20100101 Firefox/36.0';
  loginOptions = {
    uri: loginUrl,
    jar: true,
    method: 'GET',
    headers: {
      'User-Agent': userAgent
    }
  };
  log.info('Logging in on Bouygues Website...');
  return request(loginOptions, function(err, res, body) {
    var $, execution, form, lt;
    if (err) {
      log.info('Login infos could not be fetched');
      log.info(err);
      return next('bad credentials');
    }
    $ = cheerio.load(body);
    lt = $('input[name="lt"]').val();
    execution = $('input[name="execution"]').val();
    form = {
      "username": requiredFields.phoneNumber,
      "password": requiredFields.password,
      "lt": lt,
      "execution": execution,
      "_eventId": 'submit'
    };
    loginOptions = {
      method: 'POST',
      form: form,
      jar: true,
      uri: loginUrl,
      headers: {
        'User-Agent': userAgent
      }
    };
    log.info('Successfully logged in.');
    return request(loginOptions, function(err, res, body) {
      var options;
      if (err) {
        log.info(err);
        return next('bad credentials');
      }
      log.info('Download bill HTML page...');
      options = {
        method: 'GET',
        uri: billUrl,
        jar: true,
        headers: {
          'User-Agent': userAgent
        }
      };
      return request(options, function(err, res, body) {
        if (err) {
          log.info(err);
          return next('request error');
        }
        data.html = body;
        log.info('Bill page downloaded.');
        return next();
      });
    });
  });
};

parsePage = function(requiredFields, bills, data, next) {
  var $, baseDlUrl;
  baseDlUrl = "https://www.bouyguestelecom.fr";
  baseDlUrl += "/parcours/facture/download/index";
  bills.fetched = [];
  moment.locale('fr');
  $ = cheerio.load(data.html);
  $('.download-facture').each(function() {
    var amount, bill, date, id, params, url;
    date = $(this).text().trim().split(' ').splice(0, 2).join(' ').trim();
    amount = $(this).find('.small-prix').text().trim();
    amount = amount.replace('â‚¬', ',');
    id = $(this).attr('facture-id');
    params = {
      id: id
    };
    url = baseDlUrl + "?" + (qs.stringify(params));
    bill = {
      date: moment(date, 'MMMM YYYY').add(14, 'days'),
      amount: amount.replace(',', '.'),
      pdfurl: url
    };
    return bills.fetched.push(bill);
  });
  log.info('Bill data parsed.');
  return next();
};
