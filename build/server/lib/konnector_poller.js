// Generated by CoffeeScript 1.9.3
var Konnector, KonnectorPoller, async, day, format, fs, hour, importer, konnectorHash, log, moment, month, path, periods, week;

async = require("async");

moment = require("moment");

log = require('printit')({
  prefix: null,
  date: true
});

fs = require('fs');

path = require('path');

importer = require("./importer");

Konnector = require('../models/konnector');

konnectorHash = require('../lib/konnector_hash');

hour = 60 * 60 * 1000;

day = 24 * hour;

week = 7 * day;

month = 30 * day;

format = "DD/MM/YYYY [at] HH:mm:ss";

periods = {
  hour: hour,
  day: day,
  week: week,
  month: month
};

KonnectorPoller = (function() {
  function KonnectorPoller() {
    this.timeout = null;
    this.timeouts = {};
    this.nextUpdates = {};
  }

  KonnectorPoller.prototype.start = function(reset, callback) {
    if (reset == null) {
      reset = false;
    }
    if (callback == null) {
      callback = null;
    }
    log.debug("Launching Konnector Poller...");
    if (reset) {
      this.nextUpdates = {};
    }
    if (Object.keys(this.nextUpdates).length === 0) {
      return Konnector.all((function(_this) {
        return function(err, konnectors) {
          return async.eachSeries(konnectors, function(konnector, next) {
            if ((konnector.importInterval != null) && konnector.importInterval !== 'none' && (konnector.lastAutoImport != null) && (konnectorHash[konnector.slug] != null)) {
              _this.initializeKonnectorUpdates(konnector);
            }
            return next();
          }, function(err) {
            if (callback != null) {
              callback();
            }
            return _this.manageNextChecks();
          });
        };
      })(this));
    } else {
      if (callback != null) {
        callback();
      }
      return this.manageNextChecks();
    }
  };

  KonnectorPoller.prototype.initializeKonnectorUpdates = function(konnector) {
    var nextUpdate;
    nextUpdate = this.findNextUpdate(konnector);
    return this.nextUpdates[konnector.slug] = [nextUpdate, konnector];
  };

  KonnectorPoller.prototype.manageNextChecks = function() {
    this.prepareNextCheck();
    if (this.timeout != null) {
      clearTimeout(this.timeout);
    }
    return this.timeout = setTimeout(this.start.bind(this), day);
  };

  KonnectorPoller.prototype.findNextUpdate = function(konnector) {
    var importInterval, importTime, lastAutoImport, lastImport, nextUpdate, now;
    importInterval = periods[konnector.importInterval];
    now = moment();
    lastImport = moment(konnector.lastImport);
    lastAutoImport = moment(konnector.lastAutoImport);
    if ((now.valueOf() - lastAutoImport.valueOf()) > importInterval) {
      log.debug(konnector.slug + " missed an importation cycle");
      importer(konnector);
      importTime = lastAutoImport.add(importInterval, 'ms');
      while (importTime.valueOf() < now.valueOf()) {
        importTime = importTime.add(importInterval, 'ms');
      }
      log.debug((konnector.slug + " | Next update : ") + ("" + (importTime.format(format))));
      return importTime;
    } else {
      if (lastAutoImport.valueOf() > now.valueOf()) {
        nextUpdate = lastAutoImport;
      } else {
        nextUpdate = lastAutoImport.add(importInterval, 'ms');
      }
      log.debug((konnector.slug + " | Next update : ") + ("" + (nextUpdate.format(format))));
      return nextUpdate;
    }
  };

  KonnectorPoller.prototype.handleTimeout = function(startDate, konnector, callback) {
    var data, fields;
    if (callback == null) {
      callback = null;
    }
    if (this.timeouts[konnector.slug] != null) {
      clearTimeout(this.timeouts[konnector.slug]);
      delete this.timeouts[konnector.slug];
    }
    if (konnector.importInterval !== 'none') {
      konnector.injectEncryptedFields();
      if (startDate != null) {
        data = {
          lastAutoImport: moment(startDate, "DD-MM-YYYY")
        };
        fields = konnectorHash[konnector.slug];
        konnector.removeEncryptedFields(fields);
        return konnector.updateAttributes(data, (function(_this) {
          return function(err, body) {
            if (err) {
              log.error(err);
            }
            _this.create(konnector, moment(startDate, 'DD-MM-YYYY'));
            if (callback != null) {
              return callback();
            }
          };
        })(this));
      } else {
        data = {
          lastAutoImport: new Date()
        };
        konnector.lastAutoImport = new Date();
        fields = konnectorHash[konnector.slug];
        konnector.removeEncryptedFields(fields);
        konnector.updateAttributes(data, function(err, body) {
          if (err != null) {
            return log.error(err);
          }
        });
        this.create(konnector, this.findNextUpdate(konnector));
        if (callback != null) {
          return callback();
        }
      }
    } else {
      if (callback != null) {
        return callback();
      }
    }
  };

  KonnectorPoller.prototype.create = function(konnector, nextUpdate) {
    this.nextUpdates[konnector.slug] = [nextUpdate, konnector];
    log.info(konnector.slug + " : Next update " + (nextUpdate.format(format)));
    return this.createTimeout(konnector, nextUpdate);
  };

  KonnectorPoller.prototype.prepareNextCheck = function() {
    var i, konnector, len, nextUpdate, ref, ref1, results, slug;
    ref = Object.keys(this.nextUpdates);
    results = [];
    for (i = 0, len = ref.length; i < len; i++) {
      slug = ref[i];
      ref1 = this.nextUpdates[slug], nextUpdate = ref1[0], konnector = ref1[1];
      results.push(this.createTimeout(konnector, nextUpdate));
    }
    return results;
  };

  KonnectorPoller.prototype.createTimeout = function(konnector, nextUpdate) {
    var interval, now;
    now = moment();
    interval = nextUpdate.diff(now.clone(), 'ms');
    if (interval < day) {
      return this.startTimeout(konnector, interval);
    }
  };

  KonnectorPoller.prototype.startTimeout = function(konnector, interval) {
    var nextImport;
    nextImport = this.checkImport.bind(this, konnector, interval);
    if (this.timeouts[konnector.slug] != null) {
      clearTimeout(this.timeouts[konnector.slug]);
    }
    return this.timeouts[konnector.slug] = setTimeout(nextImport, interval);
  };

  KonnectorPoller.prototype.checkImport = function(konnector, interval) {
    var nextUpdate, now;
    importer(konnector);
    now = moment();
    nextUpdate = now.add(periods[konnector.importInterval], 'ms');
    return this.create(konnector, nextUpdate);
  };

  return KonnectorPoller;

})();

module.exports = new KonnectorPoller;
