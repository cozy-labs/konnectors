// Generated by CoffeeScript 1.8.0
var File, async, naming;

async = require('async');

naming = require('./naming');

File = require('../models/file');

module.exports = function(log, model, options, tags) {
  return function(requiredFields, entries, body, next) {
    if (entries.filtered == null) {
      entries.filtered = entries.fetched;
    }
    return async.eachSeries(entries.filtered, function(entry, callback) {
      var createFileAndSaveData, entryLabel, fileName, onCreated, saveEntry;
      entryLabel = entry.date.format('MMYYYY');
      fileName = naming.getEntryFileName(entry, options);
      createFileAndSaveData = function(entry, entryLabel) {
        var date, path, pdfurl;
        date = entry.date;
        pdfurl = entry.pdfurl;
        path = requiredFields.folderPath;
        return File.createNew(fileName, path, date, pdfurl, tags, onCreated);
      };
      onCreated = function(err, file) {
        if (err) {
          log.raw(err);
          log.info("File for " + entryLabel + " not created.");
          return callback();
        } else {
          log.info("File for " + entryLabel + " created: " + fileName);
          entry.fileId = file.id;
          entry.binaryId = file.binary.file.id;
          return saveEntry(entry, entryLabel);
        }
      };
      saveEntry = function(entry, entryLabel) {
        if (entry.vendor == null) {
          if (options.vendor) {
            entry.vendor = options.vendor;
          }
        }
        return model.create(entry, function(err) {
          if (err) {
            log.raw(err);
            log.error("entry for " + entryLabel + " not saved.");
          } else {
            log.info("entry for " + entryLabel + " saved.");
          }
          return callback();
        });
      };
      log.info("import for entry " + entryLabel + " started.");
      if (entry.pdfurl != null) {
        return createFileAndSaveData(entry, entryLabel);
      } else {
        log.info("No file to download for " + entryLabel + ".");
        return saveEntry(entry, entryLabel);
      }
    }, function(err) {
      return next();
    });
  };
};
